<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>mptools: Creating generic nodes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">mptools<span id="projectnumber">&#160;2.0.1</span>
   </div>
   <div id="projectbrief">Utility to create multipass virtual nodes</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_05_genericnodes.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Creating generic nodes </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >The one reason for this package existence is to make it easy to create nodes with cloud-init files. The main workhorse script to do so is <code>mkmpnode</code>.</p>
<div class="fragment"><div class="line">NAME</div>
<div class="line">   mkmpnode - Create multipass nodes with a specified (or default) cloud-init file</div>
<div class="line">USAGE</div>
<div class="line">   mkmpnode [-r RELEASE] [-c FILE] [-d SIZE] [-p CPUS] [-m SIZE] [-q] [-v] [-h] NODE_NAME</div>
<div class="line">SYNOPSIS</div>
<div class="line">      -r RELEASE: Valid ubuntu release [bionic focal impish jammy docker] ($ubuntuVer)</div>
<div class="line">      -c FILE   : Cloud config file (${defaultCloudInit})</div>
<div class="line">      -m SIZE   : Memory size, defaults (${memory})</div>
<div class="line">      -d SIZE   : Disk size, defaults (${disk}GB)</div>
<div class="line">      -p NUM    : Number of CPUs (${cpus})</div>
<div class="line">      -M        : Mount ${HOME}/Devel inside node</div>
<div class="line">      -n        : No execution. Only display actions.</div>
<div class="line">      -q        : Quiet  (no output to stdout)</div>
<div class="line">      -v        : Print version and exit</div>
<div class="line">      -h        : Print help and exit</div>
</div><!-- fragment --><dl class="section warning"><dt>Warning</dt><dd>Multipass does not allow a literal underscore in node names!</dd></dl>
<p>Most options should be self-explanatory but the <code>-M</code> deserves a comment. If the users home catalogue have a directory <code>~/Devel</code> it will be mounted automatically in the node directly under the default users (<code>ubuntu</code>) home directory.</p>
<dl class="section note"><dt>Note</dt><dd>Use the <code>-n</code> flag to do a dryrun and see how the underlying call to <code>multipass</code> is made wthout actually executing it.</dd></dl>
<h1><a class="anchor" id="autotoc_md9"></a>
Cloud init files</h1>
<p >As mentioned in the previous section <code>mkmpnode</code> uses cloud-init files to configure the created nodes. Cloud init files are written as human-readable YAML files.</p>
<blockquote class="doxtable">
<p >&zwj;<em>It is out of the scope of this readme to fully describe he full syntax of cloud-init files. <br  />
 Instead, we refer to the official home of the cloud-init project <a href="https://cloud-init.io/">cloud-init.io</a> and the description of <a href="https://cloudinit.readthedocs.io/en/latest/">Cloud-Init files</a>.</em> </p>
</blockquote>
<p>This toolset includes a few cloud-init templates, they are all stored in the <code>cloud/</code> folder in the distributed package. As of this writing the following templates are provided:</p>
<ol type="1">
<li><code>cloud/fulldev-config.in</code>, A full C/C++ dev environment</li>
<li><code>cloud/minidev-config.in</code>, A minimal c/C++ dev environment</li>
<li><code>cloud/mini-config.in</code>, A minimal node with only user and SSH keys</li>
<li><code>cloud/jenkins-config.in</code>, A basic Jenkins node</li>
<li><code>cloud/pg-config.in</code>, A basic Postgresql node</li>
</ol>
<p >These template cloud-init files will be used in the installation process to create customized versions based on the current user. The generated <code>*.yaml</code> files are stored in the user home directory under <code>~/.mptools</code>.</p>
<p >This instantiation will be done as part of the <code>make install</code> target.</p>
<h1><a class="anchor" id="autotoc_md10"></a>
Manually trigger creation of cloud-init files</h1>
<p >For experiments, it can be handy to re-generate the cloud-init file even after they have been initially created.</p>
<p >Change back to the <code>mptools</code> package directory where the <code>Makefile</code> exists. Then run the default makefile target as:</p>
<div class="fragment"><div class="line">%  make</div>
<div class="line">Transforming cloud/fulldev-config.in --&gt; cloud/fulldev-config.yaml</div>
<div class="line">Transforming cloud/jenkins-config.in --&gt; cloud/jenkins-config.yaml</div>
<div class="line">Transforming cloud/mini-config.in --&gt; cloud/mini-config.yaml</div>
<div class="line">Transforming cloud/minidev-config.in --&gt; cloud/minidev-config.yaml</div>
<div class="line">Transforming cloud/pg-config.in --&gt; cloud/pg-config.yaml</div>
<div class="line">Transforming cloud/sq-config.in --&gt; cloud/sq-config.yaml</div>
</div><!-- fragment --><p >This will add the generated <code>*.yaml</code> files (based on the current user) together with the template files in <code>./cloud</code> directory. The created files will have the current users public SSH keys and user-name inserted.</p>
<p >Please note that only files where the template files has a newer modified timestamp than any existing <code>*.yaml</code> will be re-generated. To force all <code>*.yaml</code> files to be created regardless of timestamp first run <code>make clean</code></p>
<p >The installed SSH keys in the nodes will make it easier for tools and "manual" access to the created nodes by simple ssh:ing into the nodes.</p>
<p >New cloud file templates can be easily added by, for example, copying an existing file to a new name and make modifications. The makefile will automatically pick up any new template files in the cloud directory and include them when instantiating cloud-init YAML files.</p>
<h1><a class="anchor" id="autotoc_md11"></a>
Resolving location of cloud-init files</h1>
<p >Cloud init file is specified with the <code>-c</code> option. If no cloud file is specified in the call to <code><a class="el" href="mkmpnode_8sh.html" title="mkmpnode - Setup a multipass node with options">mkmpnode.sh</a></code> the default cloud-init file will be used, <code>minidev-config.yaml</code> . This cloud-init file installs a minimal development environment in the node.</p>
<p >If the cloud init file is specified with a path then that exact file and location will be used. If the file cannot be found this results in an error message.</p>
<p >If, however only a filename without path is specified then <code>mkmpnode</code> will search for the config file in three locations in order of priority:</p>
<ol type="1">
<li>The current working directory under the subdirectory <code>./cloud</code></li>
<li>From the subdirectory <code>cloud</code> in the same folder where the script is located.</li>
<li>In the current users home directory under '~/.mptools'</li>
</ol>
<p >This priority order is used in roer to make it possible to experiment with new updated cloud-init files and have these be picked up by <code>mkmpnode</code> without having to "destroy" the original <code>*.yaml</code> files under <code>~/.mptools</code>.</p>
<p >If the cloud-init file cannot be found in any of these places an error will be written and the script will abort.</p>
<h1><a class="anchor" id="autotoc_md12"></a>
Examples of creating custom nodes</h1>
<p >We will start by illustrating how new nodes can be easily created with the help of the supplied <code>mkmpnode</code> script and later on we will show how the same process can be further simplified and automated by using <code>mpn</code></p>
<p >To execute these examples it is assumed that the cloud-init YAML files have been instantiated either by being installed (<code>make install</code>) or being instantiated as described above (with a call to the default <code>make</code> target).</p>
<p >First we are going to create a node with a custom name and more memory than default</p>
<div class="fragment"><div class="line">% mkmpnode -m 1GB mynode</div>
</div><!-- fragment --><p >This will create (and start) a new node with 1GB memory named "mynode" and initialized by the default cloud-init configuration which is set to <code>minidev-config.yaml</code> in the script.</p>
<p >By default, the created nodes will be based on the latest Ubuntu image (i.e. Ubuntu 22 LTS a.k.a. "jammy" at the time of writing).</p>
<p >If we instead wanted to create a larger node, based on Ubuntu 18 LTS with a full development configuration we would instead need to call</p>
<div class="fragment"><div class="line">% mkmpnode -r bionic -m 4GB -c fulldev-config.yaml -d 10GB mynode</div>
</div><!-- fragment --><p >This will create a node with 4GB RAM and a 10GB disk based on Ubuntu 18 (i.e. "bionic")</p>
<h2><a class="anchor" id="autotoc_md13"></a>
Setting up a Postgresql DB-server</h2>
<p >One of the cloud-init files allow for easy setup of a postgresql server. This server needs to be created manually with the help of the <code>mkmpnode</code> script since the node naming convention (used by <code>mpn</code>) has no concept of a DB server.</p>
<p >The cloud init file will set up a basic postgres server with the password specified in the cloud init file. <em>THIS IS HIGHLY INSECURE AND IS ONLY MEANT FOR TESTING AND EXPERIMENTS!</em>. See table below for the actual values.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">User/DB Owner   </th><th class="markdownTableHeadNone">Password   </th><th class="markdownTableHeadLeft">DB    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">postgres   </td><td class="markdownTableBodyNone">postgres   </td><td class="markdownTableBodyLeft">postgres    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ubuntu   </td><td class="markdownTableBodyNone">ubuntu   </td><td class="markdownTableBodyLeft">ubuntu_db   </td></tr>
</table>
<p>Table: Default roles/users created by pg-config.in</p>
<p >To create a Postgresql server (assuming the cloud yaml file have previously been instantiated) where we assume we need 2GB of RAM we could for example call</p>
<div class="fragment"><div class="line">% mkmpnode -c pg-config.yaml -m 2GB db-server</div>
</div><!-- fragment --><p >The default postresql cloud file will set up the access permission to the server so it is accessible from the outside and also create a new user "ubuntu" with default password "ubuntu" and a new DB <code>ubuntu_db</code> (for experiments) The TCP/IP access restriction is set to <code>"samenet"</code> any access must be from the same subnetwork that we are currently on (e.g. from another MP node or from the host). </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Sep 12 2022 16:14:45 for mptools by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
